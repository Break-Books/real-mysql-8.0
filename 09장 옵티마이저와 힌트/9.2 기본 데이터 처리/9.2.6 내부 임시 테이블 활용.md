# 9.2.6 내부 임시 테이블 활용

스토리지 엔진으로부터 받아온 레코드를 정렬하거나 그루핑할 때 MySQL 서버는 내부적인 임시 테이블을 사용한다. 내부적인 임시 테이블은 일반적으로 MySQL 엔진이 사용하는 임시 테이블과는 다르다.

**일반적인 임시 테이블(사용자가 생성한 임시 테이블)**
- 메모리에 생성됐다가 테이블의 크기가 커지면 디스크로 옮겨진다.
- 특정 예외 케이스에서는 바로 디스크에 임시 테이블이 생성되기도 한다.

**내부적인 임시 테이블**
- 다른 세션이나 다른 쿼리에서는 볼 수 없으며 사용하는 것이 불가능하다.
- 쿼리의 처리가 완료되면 자동으로 삭제된다.

<br>

### 9.2.6.1 메모리 임시 테이블과 디스크 임시 테이블

**MySQL 8.0 이전 버전**
- 메모리 임시 테이블
  - MEMORY 스토리지 엔진 사용
  - MEMORY 스토리지 엔진이 가변 길이 타입을 지원하지 못하므로 메모리 낭비가 심함 : 최대 길이만큼 메모리 할당
- 디스크 임시 테이블
  - MyISAM 스토리지 엔진 사용
  - MyISAM 스토리지 엔진이 트랜잭션을 지원하지 못함 : ACID를 보장 X
  - 
**MySQL 8.0**
- 메모리 임시 테이블
  - TempTable 스토리지 엔진 사용
  - TempTable 스토리지 엔진의 가변 길이 타입을 지원으로 메모리 낭비 개선
- 디스크 임시 테이블
  - InnoDB 스토리지 엔진 사용
  - 트랜잭션 지원
- `internal_tmp_mem_storage_engine` 으로 메모리용 임시 테이블을 선택 가능
  - default : TempTable

<br>

### 9.2.6.2 임시 테이블이 필요한 쿼리
다음과 같은 쿼리 패턴은 별도의 데이터 가공 작업이 필요하므로 내부 임시 테이블을 생성한다.

- ORDER BY와 GROUP BY에 명시된 컬럼이 다른 쿼리
- ORDER BY나 GROUP BY에 명시된 컬럼이 조인의 순서상 첫 번째 테이블이 아닌 쿼리
- DISTINCT와 ORDER BY가 동시에 존재하는 쿼리 또는 DISTINCT가 인덱스로 처리되지 못하는 쿼리
- UNION이나 UNION DISTINCT가 사용된 쿼리
- 쿼리의 실행 계획에서 select_type이 DERIVED인 쿼리

어떤 쿼리의 실행 계획에서 임시 테이블을 사용하는지는 Using temporary 메세지가 표시되는지 확인하면 된다.
하지만, 3번 ~ 5번 쿼리 패턴의 경우 실행 계획에 Using temporary가 표시되지 않지만 내부 임시 테이블을 사용한다.

1번 ~ 4번 쿼리 패턴의 경우 유니크 인덱스를 사용하는 내부 임시 테이블 생성하며 처리 성능이 상당히 느리다.
5번 쿼리 패턴의 경우 유니크 인덱스가 없는 내부 임시 테이블을 생성하며 1번 ~ 4번보다 처리 성능이 빠르다.


<br>

### 9.2.6.3 임시 테이블이 디스크에 생성되는 경우
내부 임시 테이블은 메모리상에 만들어지지만 아래의 경우 메모리 임시 테이블을 사용할 수 없기에 디스크 기반의 임시 테이블을 사용한다.

- UNION이나 UNION ALL에서 SELECT 되는 칼럼 중에서 길이가 512 바이트 이상인 크기의 칼럼이 있는 경우
- GROUP BY나 DISTINCT 칼럼에서 512바이트 이상인 크기의 칼럼이 있는 경우
- 임시 테이블에 저장할 데이터의 전체 크기(데이터의 바이트 크기)가 tmp_table_size 또는 max_heap_table_size 시스템 설정 값보다 큰 경우
  
<br>

### 9.2.6.4 임시 테이블 관련 상태 변수
실행 계획의 Extra를 통해 임시 테이블을 사용했다는 사실은 알 수 있지만, 임시 테이블이 메모리에서 처리됐는지 디스크에서 처리됐는지는 알 수 없으며, 몇 개의 임시 테이블이 사용됐는지도 알 수 없다. 이때 임시 테이블이 디스크에 생성됐는지 메모리에 생성됐는지 다음과 같은 상태 변수를 통해 확인할 수 있다.


```sql
// 세션 상태 값 초기화
> FLUSH STATUS;

// 조회
> SELECT ... 

// 상태 변수 확인
> SHOW SESSION STATUS LIKE 'Created_tmp%';

+--------------------------+--------+
| Variable name            |  Value |
+--------------------------+--------+
| Created_tmp_disk_tables  |      1 |
| Created_tmp_tables       |      1 |
+--------------------------+--------+
```

**Created_tmp_disk_tables**
쿼리의 처리를 위해 만들어진 내부 임시 테이블의 총 개수 (메모리에서 만들어졌는지, 디스크에서 만들어졌는지 구분 X, 누적)

**Created_tmp_tables**
디스크에 내부 임시 테이블이 만들어진 개수 (누적)

**Created_tmp_disk_tables 개수 - Created_tmp_tables 개수**
메모리에 내부 임시 테이블이 만들어진 개수