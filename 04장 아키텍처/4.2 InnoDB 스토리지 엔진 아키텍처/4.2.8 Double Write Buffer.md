# 4.2.8 Double Write Buffer

InnoDB 스토리지 엔진의 리두 로그는 공간의 낭비를 막고 빠르게 리두 로그에 쓰기 위해 페이지의 변경된 내용만 기록한다.
이로 인해 더티 페이지를 디스크 파일로 플러시 할 때 일부만 기록되는 문제가 발생하면 페이지 내용을 복구할 수 없을 수 있다.


이렇게 페이지가 일부만 기록 되는 현상을 `파셜 페이지` 또는 `톤 페이지` 라고 하는데, 이런 현상은 하드웨어 오작동이나 시스템의 비정상 종료 등으로 발생할 수 있다.

InnoDB 스토리지 엔진에서는 이 같은 문제를 막기 위해 `Double-Write 기법` 을 이용한다.

<br>

### Double-Write 기법

<br>

![](https://velog.velcdn.com/images/hellojihyoung/post/0b0f0e87-8a48-4ac4-b666-f7cf905d7c34/image.png)

InnoDb에서 A~E 까지 더티페이지를 디스크로 플러시 한다고 가정해보자.

#### 정상 동작
1. 더티 페이지를 모두 묶어서 한번에 Double Write Buffer에 기록한다.

2. InnoDB 스토리지 엔진은 각 더티 페이지를 실제로 디스크에 랜덤으로 반영한다.
   
이 경우에는 Double Write Buffer에 기록된 변경 내용이 더이상 필요가 없게 된다. 그러나 장애가 발생한 경우에는 해당 내용이 필요하게 된다.

<br>

#### 장애 발생
1. 더티 페이지를 모두 묶어서 한번에 Double Write Buffer에 기록한다.
2. InnoDB 스토리지 엔진은 각 더티 페이지를 실제로 디스크에 랜덤으로 반영하는 도중 비정상적으로 운영체제가 종료되었다.
3. InnoDB 스토리지 엔진은 재시작될 때 항상 Double Write Buffer의 내용과 실제 디스크에 기록된 데이터들을 모두 비교해 다른 내용을 담고있는 페이지가 있다면 Double Write Buffer의 내용을 데이터 파일 페이지로 복사하여 실제 디스크에 반영한다.

### 특징

- `innodb_doublewrite` 변수로 해당 기능을 사용할지 여부를 정한다.
- 데이터의 안정성을 위해 사용된다.
  - 데이터 무결성이 중요한 서비스에서 활성화하여 사용한다.
