# 4.2.5 자동 데드락 감지

* InnoDB 스토리지 엔진은 내부적으로 잠금 교착 상태에 빠지지 않게 하기 위해 잠금 대기목록을 그래프(Wait-for List) 형태로 관리한다.
* InnoDB는 데드락 감지 스레드를 가지고 있으며 이를 통해 주기적으로 잠금 대기 그래프를 검사하여 교착 상태에 빠진 트랜잭션들 중 하나를 강제로 종료한다.
* 이때 강제 종료의 기준은 언두 로그 양이며, 언두 로그 레코ㅓ드를 적게 가진 트랜잭션이 일반적으로 롤백 대상이 된다.(종료 대상)

```
* 참고 *
InnoDB 스토리지 엔진은 상위 레이어인 MySQL 엔진에서 관리되는 테이블 잠금(LOCK TABLES)은 볼수 가 없어, 데드락 유무가 불확실 할 수 있다.
이때는 innodb_table_locks 시스템 변수를 활성화하면 InnoDB 스토리지 엔진 뿐만 아니라 테이블 레벨의 잠금까지 감시가 가능하다.
```

## 데드락 감지 스레드.

### 문제.
* 동시 처리 스레드가 많거나 각 트랜잭션이 가진 잠금의 개수가 많아지면 데드락 감지 스레드의 속도가 느려진다.
* 데드락 감지 스레드는 잠금 목록을 검사할 때 잠금 상태가 변경되지 않도록 잠금 목록이 저장된 리스트에 새로운 잠금을 걸고 데드락 스레드를 찾게된다.
* 데드락 감지 스레드가 느려지면 서비스 쿼리를 처리중인 스레드는 작업을 진행하지 못하고 대기함으로 서비스에 악영향을 끼친다.
* 동시 처리 스레드가 매우 많은 경우 데드락 감지 스레드는 더 많은 CPU 자원을 소모할 수 있다.

### 해결.
* MySQL 서버는 "innodb_deadlock_detect" 시스템 변수를 제공
* "innodb_deadlock_detect"를 "OFF" 설정 시 데드락 감지 스레드는 작동하지 않는다.
* 이때 InnoDB 스토리지 엔진 내부에서 트랜잭션 끼리 잠금을 요구하는 상황이 발생해도 누군가가 중재 하지 않아, 무한정 대기가 발생할 수 있다.
* "innodb_lock_wait_timeout" 시스템 변수를 활성화 하면 데드락 상황에서 일정시간이 지나면 자동으로 요청을 실패하고 에러메시지를 반환하게 된다.
* "innodb_deadlock_detect"가 OFF일 경우 "innodb_lock_wait_timeout"은 기본 값인 50초보다 훨씬 낮은 시간으로 변경해야 한다.

