# 언두로그 

InnoDB 스토리지 엔진은 트래잭션과 격리 수준을 보장하기 위해 DML(INSERT, UPDATE, DELETE)로 변경되기 이전 버전의 데이터를 별도로 백업한다.
이렇게 백업된 데이터를 `언두로그`라고 한다.

## 언두 로그 레코드 모니터링

언두 영역은 `INSERT, UPDATE, DELET` 같은 문장으로 데이터를 변경 했을때 변경되기 전의 데이터를 보관하는 곳이다.

### 언두로그의 데이터의 용도
1. 트랜잭션의 롤백 대비.
2. 트랜잭션의 격리 수준 유지 및 높은 동시성 제공

MySQL 5.5 버전에서는 언두로그가 사용 공간이 늘어가데 되면 MySQL서버를 새로 구축하지 않는 한 줄일 방도가 없었다. 하지만 MySQL 5.7, MySQL 8.0 으로 업그레이드 되면서 언두로그를 순차적으로 사용해 용량을 줄이거나, MySQL 서버가 필요한 시점에 사용공간을 자동으로 줄여 주기도 한다.

```
mysql> SHOW ENGINE INNODB STATUS \G
# 명령어를 통해 언두로그의 레코드 건수를 조회 할 수 있다.

mysql> SELECT count FROM information_schema.innodb_metrics WHERE SUBSYSTEM='transaction' AND NAME ='trx_rseg_history_len';
# MySQL 8.0 버전에서 사용가능 한 명령.
```

MySQL에서 `Insert, Update, DELETE`의 횟수에 따라 언두 로그의 존재하는 레코드 건수는 다를 수 있으며, 서버별로 안정적인 시점에 언두 로그의 레코드 건수를 확인하여 이를 기준으로 모니터링하는 것이 좋다.

## 4.2.9.2 언두 테이블스페이스 관리

언두 로그가 저장되는 공간을 Undo Tablespace 라고 한다.

5.6 이전 버전에서는 모두 시스템 테이블스페이스에 저장이 되었다.

시스템 테이블스페이스는 mysql 이 초기화될 때 생성되기 때문에 확장의 한계가 있었다.

```
innodb_undo_tablespaces
```

위 변수를 2 보다 큰 값으로 설정하면 InnoDB 는 별도의 언두 로그 파일을 사용한다.

8.0 부터는 위 변수는 deprecated 이며, 언두 로그는 항상 별도의 로그 파일에 기록된다.

---

하나의 언두 테이블스페이스는 1 개 이상 128 개 이하의 롤백 세그먼트를 가진다.

롤백 세그먼트는 1 개 이상의 언두 슬롯을 가진다. InnoDB 페이지 크기를 16 바이트로 나눈 값의 개수만큼 언두 슬롯을 가진다.

예시:

페이지 크기가 16KB 라면 롤백 세그먼트는 1K, 즉 1024 개의 언두 슬롯을 가진다.

하나의 트랜잭션은 최대 4 개의 언두 슬롯을 사용한다. 일반적으로 2 개 정도가 필요하다고 가정한다.

```
최대 동시 트랜잭션 수 
= (InnoDB 페이지 크기) / 16 * (롤백 세그먼트 개수) * (언두 테이블스페이스 개수) // 잘못된 수식
= 언두 테이블 스페이스 개수 * 롤백 세그먼트 개수 * 언두 슬롯 개수
```

책에는 위 수식이 적혀있는데 이는 잘못 된 듯 하다. 2 로 나눠줘야 하는 것 같다.

**최소한 기본 설정을 유지하자.** 언두 로그 슬롯이 부족하면 **트랜잭션을 시작할 수 없는 심각한 문제가 발생한다.**

MySQL 8.0 부터는 새로운 언두 테이블 스페이스를 동적으로 추가하고 삭제할 수 있게 개선됐다.

---

언두 테이블 스페이스가 너무 많으면 운영체제에 반환할 수 있다. 이를 Undo tablespace truncate 라고 한다. 모두 MySQL 8.0 부터 지원된다.

```
innodb_undo_log_truncate
```

- 자동 모드: Purge Thread 가 주기적으로 깨어나 불필요해진 언두 로그를 삭제, 즉 undo purge 한다. frequency 를 조정할 수 있다.
- 수동 모드: 비활성 -> 활성하면 된다. 언두 테이블 스페이스가 최소 3 개 이상 있어야 작동한다.
