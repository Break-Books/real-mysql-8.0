# 4.2.12 어댑티브 해시 인덱스

### 어댑티브 해시 인덱스
사용자가 수동으로 생성한 인덱스가 아닌 **InnoDB 스토리지 엔진에서 사용자가 자주 요청하는 데이터에 대해 자동으로 생성하는 인덱스**이다.
- `innodb_adaptive_hash_index`로 인덱스 기능 활성화/비활성화 가능

B-Tree의 검색 시간을 줄이기 위해 도입된 기능으로, 자주 읽히는 데이터 페이지의 키 값을 이용해 해시 인덱스를 만들고 필요할 때마다 어댑티브 해시 인덱스를 검색해 레코드가 저장된 데이터 페이지를 즉시 찾아갈 수 있게 해 준다.

따라서 B-Tree를 루트 노드부터 리프 노드까지 찾아가는 비용이 없어지고 쿼리 성능이 빨라지기 대문에 컴퓨터는 더 많은 쿼리를 동시에 처리할 수 있게 된다.

<br>

### 해시 인덱스
`인덱스 키 값`과 해당 `인덱스의 키 값이 저장된 데이터 페이지 주소`의 쌍으로 관리되며, 인덱스 키 값은 B-Tree 인덱스의 `고유 ID`와 B-Tree 인덱스의 `실제 키 값`의 조합으로 생성된다.
- 모든 B-Tree 인덱스에 대한 어댑티브 해시 인덱스가 하나의 해시 인덱스에 저장되며, 특정 키 값이 어느 인덱스에 속한 것인지 구분하기 위해 B-Tree 인덱스의 `고유 ID`를 사용한다.
- 데이터 페이지 주소는 실제 키 값이 저장된 데이터 페이지의 메모리 주소를 가지는데, 이는 InnoDB 버퍼 풀에 로딩된 페이지 주소를 의미한다.

<br>

### 어댑티브 해시 인덱스로 인한 성능 향상
어댑티브 해시 인덱스를 사용한다고 해서 무조건 성능이 향상되는 것은 아니다.

#### 성능 향상에 크게 도움이 되지 않는 경우

- **디스크 읽기가 많은 경우**
  - 어댑티브 해시 인덱스는 데이터 페이지를 메모리(버퍼 풀) 내에서 접근하는 것을 더 빠르게 만들기 때문
- 특정 패턴의 쿼리가 많은 경우(LIKE 패턴 검색이나 조인)
- 매우 큰 데이터를 가진 테이블의 레코드를 폭넓게 읽는 경우

#### 성능 향상에 도움이 되는 경우

- 디스크의 데이터가 InnoDB 버퍼 풀 크기와 비슷한 경우(디스크 읽기가 많지 않은 경우)
- 동등 조건 검색(동등 비교와 IN 연산자)이 많은 경우
- 쿼리가 데이터 중에서 일부 데이터에만 집중되는 경우

어댑티브 해시 인덱스 또한 데이터 **페이지의 인덱스 키가 해시 인덱스로 만들어져**야 하고 **불필요한 경우 제거**돼야 하며, 어댑티브 해시 인덱스가 활성화되면 InnoDB 스토리지 엔진은 그 키 값이 해시 인덱스에 있든 없든 검색해봐야 한다. 따라서 효율이 없는 경우에도 해시 인덱스를 InnoDB는 계속 사용하게 된다.

<br>

어댑티브 해시 인덱스는 **테이블의 삭제 작업**에도 많은 영향을 미친다.
 - 어떤 테이블의 인덱스가 어댑티브 해시 인덱스에 적재되어 있다고 가정해보자.
 - 이때 이 테이블을 삭제(Drop)하거나 변경(Alter)하려고 하면 InnoDB 스토리지 엔진은 이 테이블이 가진 모든 데이터 페이지의 내용을 어댑티브 해시 인덱스에서 제거해야한다.
 - 이로 인해 테이블이 삭제되거나 스키마가 변경되는 동안 상당히 많은 CPU 자원을 사용하고, 그만큼 데이터베이스 서버의 처러 성능은 느려진다.

그렇기 때문에 어댑티브 해시 인덱스의 도움을 많이 받을수록 **테이블 삭제 또는 변경 작업(Online DDL 포함)은 더 치명적인 작업**이 되기에 주의해서 사용해야 한다.

어댑티브 해시 인덱스가 유용하게 사용되고 있는지 지속적으로 모니터링 하는 것이 중요하다.