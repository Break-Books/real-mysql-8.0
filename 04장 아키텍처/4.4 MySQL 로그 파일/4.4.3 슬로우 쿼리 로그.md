# 4.4.3 슬로우 쿼리 로그

쿼리 튜닝은 두 가지로 나뉜다.

- 서비스 적용 전 전체적 튜닝
- 서비스 운영 중 검사 및 정기 점검 튜닝

후자의 경우는 문제를 판단하기 상당히 어렵다.

이런 경우 슬로우 쿼리 로그가 도움이 된다.

슬로우 쿼리 로그 파일은 long_query_time 이상의ㅏ 시간이 소요된 쿼리가 모두 기록된다.

일단은 무조건 정상적으로 실행이 되어야 한다.

이것도 마찬가지로 테이블 혹은 파일로 기록할지 선택할 수 있다.

파일로 선택하면 CSV 스토리지 엔진을 사용한다.

슬로우 쿼리 파일은

Time 항목은 쿼리 종료 시점이다. 쿼리 시작 시점은 Time - Query_Time 이다.

Query_Time 은 쿼리가 실행되는 데에 걸린 전체 시간이다. Lock_time 은 mysql 엔진 레벨 테이블 잠금 대기시간만 표현한다. 0 이 아니라고 해서 무조건 잠금 대기가 있었다고 판단하기는 어렵다. 잠금 체크와 코드 실행 부분까지 모두 포함하기 때문이다.

Rows_examined 은 쿼리가 처리되기 위해 몇 건의 레코드에 접근했는지를 의미한다.

**Rows_examined 의 레코드 건수는 높짐나 Rows_sent 건수가 적다면 이 쿼리는 조금 더 적은 레코드만 접근하도록 튜닝해 볼 가치가 있는 것이다!**

InnoDB 에서는 MVCC 같은 메커니즘이 있어서 select 가 빠르다. 하지만 가끔가다가도 Lock_time 이 클 수도 있는데, 이는 InnoDB 레코드 수준의 잠금이 아니라 MySQL 엔진 수준의 테이블 잠금 때문일 가능성이 높다. 때문에 InnoDB 테이블만 접근하는 쿼리 문장에서 Lock_time 은 별로 쿼리 분석에 도움이 되지 않는다.

## 4.4.3.1 슬로우 쿼리 통계

Percona Toolkit 의 pt-query-digest 의 사용법에 대한 간단한 꿀팁 모음이다.

pt-query-digest --type='slowlog' mysql-slow.log > parsed_mysql-slog.log

## 4.4.3.2 실행 빈도 및 누적 실행 시간순 랭킹

```
--order-by 옵션
```

## 4.4.3.3 쿼리별 실행 횟수 및 누적 실행 시간 상세 정보

랭킹별 쿼리에서는 대상 테이블에 대해 어떤 쿼리인지만을 표시한다. 상세한 쿼리 내용은 개별 쿼리의 정보를 확인하면 된다.

응답시간에 대한 히스토그램같은 상세한 내용을 보여준다.
